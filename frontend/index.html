<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blog / Mural de Posts</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container my-5">
  <h1 class="mb-4">Blog / Mural de Posts</h1>

  <!-- Formulário para criar/atualizar post -->
  <form id="postForm" class="mb-4">
    <input type="hidden" id="postId">
    <div class="mb-3">
      <label for="title" class="form-label">Título</label>
      <input type="text" class="form-control" id="title" required>
    </div>
    <div class="mb-3">
      <label for="content" class="form-label">Conteúdo</label>
      <textarea class="form-control" id="content" required></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Salvar Post</button>
    <button type="button" class="btn btn-secondary" id="cancelEdit" style="display: none;">Cancelar Edição</button>
  </form>

  <!-- Lista de posts -->
  <div id="postsList" class="list-group"></div>

  <!-- Botão para exportar JSON -->
  <button class="btn btn-info mt-4" id="exportBtn">Exportar Posts como JSON</button>

  <script>
    const apiUrl = 'http://localhost:3000';

    // Função para listar posts
    async function loadPosts() {
      try {
        const response = await fetch(`${apiUrl}/posts`);
        if (!response.ok) throw new Error('Erro ao carregar posts');
        const posts = await response.json();
        const postsList = document.getElementById('postsList');
        postsList.innerHTML = '';
        posts.forEach(post => {
          const postItem = document.createElement('div');
          postItem.className = 'list-group-item';
          postItem.innerHTML = `
            <h5>${post.title}</h5>
            <p>${post.content}</p>
            <small>Criado em: ${new Date(post.createdAt).toLocaleString()}</small>
            <button class="btn btn-sm btn-warning" onclick="editPost('${post._id}')">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="deletePost('${post._id}')">Excluir</button>
            <div class="mt-3">
              <h6>Comentários:</h6>
              ${post.comments.map(comment => `<p>${comment.content} <small>(${new Date(comment.createdAt).toLocaleString()})</small></p>`).join('')}
              <form class="commentForm" data-post-id="${post._id}">
                <input type="text" class="form-control mb-2" placeholder="Adicionar comentário" required>
                <button type="submit" class="btn btn-sm btn-primary">Comentar</button>
              </form>
            </div>
          `;
          postsList.appendChild(postItem);

          // Adicionar listener para formulário de comentário
          const commentForm = postItem.querySelector('.commentForm');
          commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = commentForm.querySelector('input').value;
            await fetch(`${apiUrl}/posts/${post._id}/comments`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content })
            });
            commentForm.reset();
            loadPosts();
          });
        });
      } catch (err) {
        console.error('Erro no front-end:', err);
      }
    }

    // Criar ou atualizar post
    document.getElementById('postForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('postId').value;
      const title = document.getElementById('title').value;
      const content = document.getElementById('content').value;
      const method = id ? 'PUT' : 'POST';
      const url = id ? `${apiUrl}/posts/${id}` : `${apiUrl}/posts`;
      try {
        await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, content })
        });
        document.getElementById('postForm').reset();
        document.getElementById('postId').value = '';
        document.getElementById('cancelEdit').style.display = 'none';
        loadPosts();
      } catch (err) {
        console.error('Erro ao salvar post:', err);
      }
    });

    // Editar post
    async function editPost(id) {
      try {
        const response = await fetch(`${apiUrl}/posts/${id}`);
        const post = await response.json();
        document.getElementById('postId').value = post._id;
        document.getElementById('title').value = post.title;
        document.getElementById('content').value = post.content;
        document.getElementById('cancelEdit').style.display = 'inline-block';
      } catch (err) {
        console.error('Erro ao carregar post para edição:', err);
      }
    }

    // Cancelar edição
    document.getElementById('cancelEdit').addEventListener('click', () => {
      document.getElementById('postForm').reset();
      document.getElementById('postId').value = '';
      document.getElementById('cancelEdit').style.display = 'none';
    });

    // Excluir post
    async function deletePost(id) {
      if (confirm('Tem certeza que deseja excluir?')) {
        try {
          await fetch(`${apiUrl}/posts/${id}`, { method: 'DELETE' });
          loadPosts();
        } catch (err) {
          console.error('Erro ao excluir post:', err);
        }
      }
    }

    // Exportar JSON
    document.getElementById('exportBtn').addEventListener('click', async () => {
      try {
        const response = await fetch(`${apiUrl}/export`);
        const data = await response.json();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'posts.json';
        a.click();
      } catch (err) {
        console.error('Erro ao exportar JSON:', err);
      }
    });

    // Carregar posts iniciais
    loadPosts();
  </script>
</body>
</html>